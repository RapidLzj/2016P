# SAGE巡天观测日志系统

## 简介

本系统用于SAGE巡天观测，主要任务为日志记录和查看。包括观测安排、观测日志撰写、日志查看和打印等。

## 数据库

使用mysql数据库。共6个表。其中望远镜表为固定表，在系统中不提供修改。观测期、观测夜由观测安排部分进行编辑，观测日志由日志撰写部分编辑，文件基本信息则不在本系统中编辑，由外部程序读取文件头导入。

#### 用户 Person

| 字段 | 类型 | 说明 |
|------|------|------|
| PID    | int(11)  | 用户编号，自动增长 |
| PLogin | tinytext | 用户登录名 |
| PPswd  | tinytext | 用户密码（简化起见，用明文） |
| PLevel | int(11)  | 用户权限，整数，各位表示不同权限 |
| PName  | tinytext | 用户姓名 |
| PInfo  | tinytext | 用户信息，包括单位、电话等等，作为备注 |

#### 望远镜 Telescope

| 字段 | 类型 | 说明 |
|------|------|------|
| Telescope | char(5)  | 通常为3-5个字母的望远镜代号 |
| FullName  | tinytext | 望远镜全名 |
| TimeZone  | int(2)   | 望远镜所在地时区（官方时区） |
| Lon       | float    | 经度（度） |
| Lat       | float    | 纬度（度） |
| Ele       | float    | 海拔（米）|
| Note      | tinytext | 备注 |
| LevelMask | int      | 权限掩码，指明撰写本望远镜日志的权限位 |

#### 观测期 ObsRun

| 字段 | 类型 | 说明 |
|------|------|------|
| RunID     | char(8)  | 观测期名称，通常为TyyyymmX格式 |
| Telescope | char(5)  | 望远镜代号 |
| FromJD    | int(11)  | 开始日期儒略日（根据观测开始的UTC时间） |
| ToJD      | int(11)  | 结束日期 |
| FromDate  | char(8)  | 开始日期文本格式（当地时间，yyyymmdd） |
| ToDate    | char(8)  | 结束日期文本格式 |
| Filters   | tinytext | 本期使用的滤光片 |
| Note      | tinytext | 备注，是测试，还是观测，或者其他情形 |

#### 观测夜 ObsNight

| 字段 | 类型 | 说明 |
|------|------|------|
| NightID | char(5)  | 夜晚编号，4位儒略日加上望远镜编号字母 |
| MJD     | int(11)  | 儒略日 |
| RunID   | char(8)  | 观测期 |
| DateStr | char(8)  | 日期文本（本项目以及以上由安排程序填写） |
| Weather | tinytext | 天气情况（日志填写） |
| Plan    | tinytext | 当晚观测计划简述 |
| Result  | tinytext | 当晚观测结果简述 |
| Note    | tinytext | 备注 |
| Status  | int      | 状态，当天晚上观测情况 |

#### 观测日志 ObsLog

| 字段 | 类型 | 说明 |
|------|------|------|
| LineID  | int(11)  | 记录序号，自动增长 |
| NightID | char(5)  | 夜晚编号 |
| LogTime | int(11)  | 事件时间（从中午12:00:00开始的秒数） |
| FromSN  | int(11)  | 事件对应观测文件起始编号，可以为空 |
| ToSN    | int(11)  | 结束编号，可以为空 |
| Event   | tinytext | 事件描述 |
| Note    | tinytext | 备注 |

#### 文件基本信息 FileBasic

| 字段 | 类型 | 说明 |
|------|------|------|
| FileID     | char(9)  | 文件编号：jjjjTnnnn |
| MJD        | int(11)  | 儒略日 |
| Telescope  | char(1)  | 望远镜一位代码 |
| ObsTime    | int(11)  | 观测时间（12:00:00开始的秒数） |
| SN         | int(11)  | 文件序列号 |
| Type       | char(1)  | 目标类型：Bias/Flat/Survey/Other/Test/Bad |
| Object     | tinytext | 目标名称 |
| Filter     | tinytext | 滤光片（系统原始名称） |
| FilterCode | char(1)  | 滤光片代号（单字母） |
| ExpTime    | float    | 曝光长度 |
| RADeg      | double   | 目标赤经（度） |
| DecDeg     | double   | 目标赤纬（度） |
| Tag        | int(11)  | 标签 |
| FileName   | tinytext | 文件在服务器上全名 |
| Note       | tinytext | 文件备注 |

## 程序模块

### 公共部分

#### 登录

##### index.php
系统登录页面，默认首页。如果发现已经登录，则转向main。如果登录失败，显示提示。

##### const.php
提供系统基本的常数，比如权限常数等。

##### util.php
提供一些常用的函数。

#### 权限系统

##### priv.php
权限检查，被包含文件。根据cookie读出权限信息，并且保存在变量中。

权限二进制各位代表意义：0，是否可登陆；1-12，具体各望远镜日志撰写，根据望远镜表权限字段分配；14，观测安排权限；15，用户管理权限。

##### selfedit.php & selfsave.php
个人信息编辑，密码修改等。

##### userlist.php
用户列表和编辑。

##### useredit.php & usersave.php
其他用户信息编辑，密码修改等。

##### exit.php
退出登录，清空cookie。

#### 外观

##### obslog.css & obslogprint.css
样式表系统，简单布局。后者基本上与前者相同，但是针对打印模式，隐藏了头部和尾部等。

##### head.php
被包含文件，提供页面头部，主要显示系统名称、已登录账户，以及根据当前权限显示的菜单。

##### foot.php
被包含文件，提供页面底部。主要是版权信息等。

##### main.php
登录后的首页，显示欢迎信息，以及当前的观测信息统计：分望远镜表示有几个观测期，每个观测期有几个晚上，有多少个晚上有日志，每个晚上有几个文件等。

观测夜状态字段，各位表示不同含义：0，是否已经观测；1，是否共享夜（只有半个晚上）；2，是否受天气影响；3，是否受设备问题影响；4，是否因计划调整影响；5，其他影响。

组合起来，全0表示还未观测，非0表示这一天状态已经确认了。

#### 数据库

##### conn.php
打开数据库连接。

##### conx.php
关闭数据库连接，并结束程序。

### 观测安排

##### runedit.php & runsave.php
新建或者编辑一个观测期的信息。观测期的起止日期以JD为准，字符串根据JD以及望远镜所在时区生成。（通常根据望远镜所在时区的标准时间18:00所在的JD表示，即-6区以及以东，和当地日期相同，-7区以及以西，是当地日期的下一天）。

保存观测期时，根据设置的起止日期，生成（修改）观测夜信息等。未开始（当前日期在开始日期之前）的观测期，可以修改起止日期；观测开始之后，在结束日期之后10天之内，可以延期，扩展结束日期。对于已有观测记录的日期，不能从观测期中删除。如果观测开始之后出现观测提前结束的，在指定日期的观测记录中填写取消，不能删除。

##### rundetail.php
观测夜列表，根据参数指定的观测期，列出观测夜，包括基本信息、状态、文件数等。可以选择进入填写或者查看日志。

### 观测日志填写

##### nigthedit.php & nigthsave.php
指定观测夜的日志填写和保存。日志分为暂存和提交两个不同操作，在暂存操作时，会将所填写的日志保存，但是只有到了提交的时候，才会出现在正式日志中。每次暂存之后，或者进入编辑的时候，都会提供10个空日志行供批量填写。

### 观测日志查看

##### nightlog.php
显示指定晚上的日志。

##### nightfile.php
显示指定晚上的文件列表。